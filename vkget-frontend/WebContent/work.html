<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Visual Knowledge Graph Editing Tool">
<meta name="author" content="ales.woska@gmail.com">

<link href="favicon.png" rel="icon" type="image/png" />

<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css" />
<link rel="stylesheet" type="text/css" href="css/bootstrap-theme.min.css" />
<link rel="stylesheet" type="text/css" href="css/fix.css" />
<link rel="stylesheet" type="text/css" href="css/vkget.css" />

<script src="js/jquery-1.12.2.min.js"></script>
<script src="js/angular.min.js"></script>
<script src="js/bootstrap.min.js"></script>

<title>Visual Knowledge Graph Editing Tool Home</title>
</head>

<body ng-app="vkget">
	<div>
		<div ng-include="'menu.html'"></div>
		<div id="workspace" ng-controller="dataController">
			<canvas id="panelCanvas" height="700px" width="1500px"></canvas>

			<table ng-repeat="table in dataModel.tables" class="vkget_table"
				style="
					background-color: {{layouts[table.typeUri].background}};
					color: {{layouts[table.typeUri].fontColor}};
					font-size: {{layouts[table.typeUri].fontSize}}px;
					left: {{layouts[table.typeUri].left}}px;
					top: {{layouts[table.typeUri].top}}px;
					width: {{layouts[table.typeUri].width}}px;
					border: {{layouts[table.typeUri].lineThickness}}px {{layouts[table.typeUri].lineType}} {{layouts[table.typeUri].lineColor}};">
				
				<thead style="border-bottom: {{layouts[table.typeUri].lineThickness}}px {{layouts[table.typeUri].lineType}} {{layouts[table.typeUri].lineColor}};">
					<tr>
						<th style="border-bottom: {{layouts[table.typeUri].lineThickness}}px {{layouts[table.typeUri].lineType}} {{layouts[table.typeUri].lineColor}};"
							class="caption" colspan="{{table.columnsURIs.length}}">
							{{layouts[table.typeUri].title}}</th>
					</tr>
					<tr>
						<th class="columnCaption" ng-repeat="property in table.columnsURIs" 
							style="width: {{layouts[table.typeUri].width / table.columnsURIs.length}}px;"
							ng-click="order(this, $index);">
							{{getTitleForProperty(layouts[table.typeUri], property);}}
						</th>
					</tr>
					<tr>
						<th ng-repeat="property in table.columnsURIs" style="width: {{layouts[table.typeUri].width / table.columnsURIs.length}}px;">
							<input type="text" style="width: 100px;" ng-model="search[$index]" ng-change="filter(this, $index);" />
						</th>
					</tr>
				</thead>
				
				<tbody style="height: {{layouts[table.typeUri].height}}px;">
					<tr ng-repeat="instance in table.instances | filter:filterText">
						<td ng-repeat="property in instance.literalProperties" 
							style="width: {{layouts[table.typeUri].width / instance.literalProperties.length}}px;">
							{{property.value}}
						</td>
					</tr>
				</tbody>
								
			</table>
			
			<div ng-repeat="layout in screenLayout.lineLayouts" class="vkget_line_title"
				style="color: {{layout.fontColor}}; font-size: {{layout.fontSize}}px; left: {{layout.left}}px; top: {{layout.top}}px;">
				{{layout.title}}
			</div>
			
		</div>
	</div>
	
	<script>
		var app = angular.module('vkget', [])
	
		app.controller('dataController', function($scope, $http, $filter) {
			$scope.sort = {
		        column: 0,
		        reverse: true
		    };
			
			$scope.filter = {
		        column: 0,
		        text: ""
		    };
			
			$scope.getTitleForProperty = function(layout, property) {
				if (layout === undefined) {
					return "";
				}
	        	for (var j in layout.properties) {
	        		var rl = layout.properties[j];
	        		if (rl.property == property) {
	        			return rl.title;
	        		}
	        	}
			};
		    
			$scope.order = function(scope, index) {
				$scope.sort.column = index;
				$scope.sort.reverse = !$scope.sort.reverse; 
				var reverse = $scope.sort.reverse;
		        scope.table.instances = $filter('orderBy')(scope.table.instances, $scope.mySorter, reverse);
		    };
		    
			$scope.filter = function(scope, index) {
				$scope.filter.column = index;
				$scope.filter.text = scope.search[index];
		        scope.table.instances = $filter('filter')(scope.table.instances, $scope.myFilter);
		    };
			
			$scope.mySorter = function(item) {
				var sortByColumn = $scope.sort.column;
				return item.literalProperties[sortByColumn].value;
			}
			
			$scope.myFilter = function(item) {
				if ($scope.filter.text == "") {
					return true;
				} else {
					var col = $scope.filter.column;
					var text = $scope.filter.text;
					var value = item.literalProperties[col].value.toString();
					return value.toLowerCase().indexOf(text.toLowerCase()) >= 0;
				}
			};
			
			$http.get("http://localhost:8090/data/aaa")
		    .then(function(response) {
		    	var dataModel = response.data;
				for (var i = 0; i < dataModel.tables.length; i++) {
					var table = dataModel.tables[i];
					var scope = [];
					scope['table'] = table;
					$scope.order(scope, 0);
				}
				$scope.dataModel = dataModel;
		    });
			
			$http.get("http://localhost:8090/layout?uri=http://mff.cuni.cz/test.woska.layout")
		    .then(function(response) {
		        var layout = response.data;
		        $scope.screenLayout = layout;
		        var layouts = {}
		        for (var key in layout.blockLayouts) {
		        	var bl = layout.blockLayouts[key];
		        	layouts[bl.forType] = bl;
		        }
		        $scope.layouts = layouts;
				var c = document.getElementById('panelCanvas');
				var ctx = c.getContext('2d');
				for (var i in $scope.screenLayout.lineLayouts) {
					layout = $scope.screenLayout.lineLayouts[i];
					ctx.beginPath();
					if (layout.lineType == 'dashed') {
						ctx.setLineDash([5,5]);
					} else if (layout.lineType == 'dotted') {
						ctx.setLineDash([1,5]);
					}
					ctx.lineWidth = layout.lineThickness;
					ctx.strokeStyle = layout.lineColor;
					if (layout.points.length > 1) {
						var first = layout.points[0];
						ctx.moveTo(first.x, first.y);
						for (var i = 1; i < layout.points.length; i++) {
							var point = layout.points[i];
							ctx.lineTo(point.x, point.y);
						}
					}
					ctx.stroke();
				}
		    });
		});
	</script>
	
</body>
</html>
